<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前言 | 小丸子首页</title>
    <meta name="description" content="小丸子的前端记录">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/icon.jpeg">
    
    <link rel="preload" href="/assets/css/0.styles.45955094.css" as="style"><link rel="preload" href="/assets/js/app.e7fdb41b.js" as="script"><link rel="preload" href="/assets/js/2.b0083da8.js" as="script"><link rel="preload" href="/assets/js/62.94301d21.js" as="script"><link rel="prefetch" href="/assets/js/10.87df7023.js"><link rel="prefetch" href="/assets/js/100.58a6ddd0.js"><link rel="prefetch" href="/assets/js/101.038b3e10.js"><link rel="prefetch" href="/assets/js/102.2d08e955.js"><link rel="prefetch" href="/assets/js/103.d669fdff.js"><link rel="prefetch" href="/assets/js/104.29636da9.js"><link rel="prefetch" href="/assets/js/105.3e6b8ddd.js"><link rel="prefetch" href="/assets/js/106.4393ae7b.js"><link rel="prefetch" href="/assets/js/107.103fad7c.js"><link rel="prefetch" href="/assets/js/108.d26cf418.js"><link rel="prefetch" href="/assets/js/109.84f30560.js"><link rel="prefetch" href="/assets/js/11.0381eb27.js"><link rel="prefetch" href="/assets/js/110.7acd8629.js"><link rel="prefetch" href="/assets/js/111.ab4ef482.js"><link rel="prefetch" href="/assets/js/112.e924bad3.js"><link rel="prefetch" href="/assets/js/113.2ff26b1b.js"><link rel="prefetch" href="/assets/js/114.3bf9b309.js"><link rel="prefetch" href="/assets/js/115.42d10199.js"><link rel="prefetch" href="/assets/js/116.d57bfb59.js"><link rel="prefetch" href="/assets/js/117.7dd45495.js"><link rel="prefetch" href="/assets/js/118.f487f982.js"><link rel="prefetch" href="/assets/js/119.876ace61.js"><link rel="prefetch" href="/assets/js/12.6eecc86a.js"><link rel="prefetch" href="/assets/js/120.ee00d2a3.js"><link rel="prefetch" href="/assets/js/121.70f8ae42.js"><link rel="prefetch" href="/assets/js/13.6da5d029.js"><link rel="prefetch" href="/assets/js/14.f9a6fb28.js"><link rel="prefetch" href="/assets/js/15.24d654c0.js"><link rel="prefetch" href="/assets/js/16.953932b8.js"><link rel="prefetch" href="/assets/js/17.4708df9f.js"><link rel="prefetch" href="/assets/js/18.be3f59bc.js"><link rel="prefetch" href="/assets/js/19.5dba8061.js"><link rel="prefetch" href="/assets/js/20.f8216a32.js"><link rel="prefetch" href="/assets/js/21.10d66581.js"><link rel="prefetch" href="/assets/js/22.14ebcd74.js"><link rel="prefetch" href="/assets/js/23.61ca7d9f.js"><link rel="prefetch" href="/assets/js/24.a5b29405.js"><link rel="prefetch" href="/assets/js/25.586907b5.js"><link rel="prefetch" href="/assets/js/26.c0e3958c.js"><link rel="prefetch" href="/assets/js/27.c4eab220.js"><link rel="prefetch" href="/assets/js/28.611f73f1.js"><link rel="prefetch" href="/assets/js/29.a377fb3b.js"><link rel="prefetch" href="/assets/js/3.4f94c2b6.js"><link rel="prefetch" href="/assets/js/30.9485ff90.js"><link rel="prefetch" href="/assets/js/31.b9917034.js"><link rel="prefetch" href="/assets/js/32.63a00b87.js"><link rel="prefetch" href="/assets/js/33.30ae370d.js"><link rel="prefetch" href="/assets/js/34.0f9141db.js"><link rel="prefetch" href="/assets/js/35.da1124eb.js"><link rel="prefetch" href="/assets/js/36.6ffad5be.js"><link rel="prefetch" href="/assets/js/37.0e3d116d.js"><link rel="prefetch" href="/assets/js/38.15d60c1c.js"><link rel="prefetch" href="/assets/js/39.b6b5bbef.js"><link rel="prefetch" href="/assets/js/4.50415caa.js"><link rel="prefetch" href="/assets/js/40.f58ab30a.js"><link rel="prefetch" href="/assets/js/41.74acf70d.js"><link rel="prefetch" href="/assets/js/42.8ea5ea3a.js"><link rel="prefetch" href="/assets/js/43.522305f5.js"><link rel="prefetch" href="/assets/js/44.ebccab49.js"><link rel="prefetch" href="/assets/js/45.73be73e0.js"><link rel="prefetch" href="/assets/js/46.06a410fc.js"><link rel="prefetch" href="/assets/js/47.b4cdf463.js"><link rel="prefetch" href="/assets/js/48.9e5621b4.js"><link rel="prefetch" href="/assets/js/49.6698a4c1.js"><link rel="prefetch" href="/assets/js/5.3a34a538.js"><link rel="prefetch" href="/assets/js/50.c39d881f.js"><link rel="prefetch" href="/assets/js/51.c8ab039e.js"><link rel="prefetch" href="/assets/js/52.3aa1aa50.js"><link rel="prefetch" href="/assets/js/53.29ad864c.js"><link rel="prefetch" href="/assets/js/54.15389d53.js"><link rel="prefetch" href="/assets/js/55.4e42c79c.js"><link rel="prefetch" href="/assets/js/56.af8d7e43.js"><link rel="prefetch" href="/assets/js/57.fa08c528.js"><link rel="prefetch" href="/assets/js/58.6104e082.js"><link rel="prefetch" href="/assets/js/59.ebbcca3d.js"><link rel="prefetch" href="/assets/js/6.a99d3f0f.js"><link rel="prefetch" href="/assets/js/60.547affef.js"><link rel="prefetch" href="/assets/js/61.2e83a997.js"><link rel="prefetch" href="/assets/js/63.e7c8d208.js"><link rel="prefetch" href="/assets/js/64.a6699a3b.js"><link rel="prefetch" href="/assets/js/65.e4952fd3.js"><link rel="prefetch" href="/assets/js/66.6501411a.js"><link rel="prefetch" href="/assets/js/67.419480da.js"><link rel="prefetch" href="/assets/js/68.e63d91fd.js"><link rel="prefetch" href="/assets/js/69.69c62090.js"><link rel="prefetch" href="/assets/js/7.f0d9e7d6.js"><link rel="prefetch" href="/assets/js/70.4d88aed2.js"><link rel="prefetch" href="/assets/js/71.49996204.js"><link rel="prefetch" href="/assets/js/72.ea6ea126.js"><link rel="prefetch" href="/assets/js/73.a5e0bd3c.js"><link rel="prefetch" href="/assets/js/74.58d1733c.js"><link rel="prefetch" href="/assets/js/75.5aa36347.js"><link rel="prefetch" href="/assets/js/76.05672032.js"><link rel="prefetch" href="/assets/js/77.4f14c24a.js"><link rel="prefetch" href="/assets/js/78.8672519d.js"><link rel="prefetch" href="/assets/js/79.256664f4.js"><link rel="prefetch" href="/assets/js/8.78768f31.js"><link rel="prefetch" href="/assets/js/80.a2b66109.js"><link rel="prefetch" href="/assets/js/81.9936f986.js"><link rel="prefetch" href="/assets/js/82.9b2fcd02.js"><link rel="prefetch" href="/assets/js/83.0ba7352a.js"><link rel="prefetch" href="/assets/js/84.20e77b39.js"><link rel="prefetch" href="/assets/js/85.52759596.js"><link rel="prefetch" href="/assets/js/86.dffd9e09.js"><link rel="prefetch" href="/assets/js/87.f5e19b45.js"><link rel="prefetch" href="/assets/js/88.da1fb41e.js"><link rel="prefetch" href="/assets/js/89.57aacf07.js"><link rel="prefetch" href="/assets/js/9.402b324f.js"><link rel="prefetch" href="/assets/js/90.df2f7983.js"><link rel="prefetch" href="/assets/js/91.4ba8b58c.js"><link rel="prefetch" href="/assets/js/92.ec45e144.js"><link rel="prefetch" href="/assets/js/93.63abc93f.js"><link rel="prefetch" href="/assets/js/94.e6964747.js"><link rel="prefetch" href="/assets/js/95.e3f904f4.js"><link rel="prefetch" href="/assets/js/96.a9e5adb8.js"><link rel="prefetch" href="/assets/js/97.6539b7e5.js"><link rel="prefetch" href="/assets/js/98.09d00a36.js"><link rel="prefetch" href="/assets/js/99.d26afb5f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.45955094.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/icon.jpeg" alt="小丸子首页" class="logo"> <span class="site-name can-hide">小丸子首页</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/frontEnd/js基础/执行上下文栈.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/pages/network/TCP/TCP连接的建立和断开.html" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/pages/browser/输入url到页面展示发生了什么.html" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/pages/algorithm/链表/2-两数相加.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/pages/other/linux命令行.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/yh418807968" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/pages/frontEnd/js基础/执行上下文栈.html" class="nav-link">
  前端
</a></div><div class="nav-item"><a href="/pages/network/TCP/TCP连接的建立和断开.html" class="nav-link">
  网络
</a></div><div class="nav-item"><a href="/pages/browser/输入url到页面展示发生了什么.html" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/pages/algorithm/链表/2-两数相加.html" class="nav-link">
  算法
</a></div><div class="nav-item"><a href="/pages/other/linux命令行.html" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="https://github.com/yh418807968" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/pages/browser/输入url到页面展示发生了什么.html" class="sidebar-link">输入url到页面展示发生了什么</a></li><li><a href="/pages/browser/cookie.html" class="sidebar-link">cookie</a></li><li><a href="/pages/browser/跨域通信.html" class="active sidebar-link">跨域通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#同源策略" class="sidebar-link">同源策略</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#跨域通信" class="sidebar-link">跨域通信</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#cors" class="sidebar-link">CORS</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#postmessage" class="sidebar-link">postMessage</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#websocket" class="sidebar-link">websocket</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#node中间件代理" class="sidebar-link">node中间件代理</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#nginx反向代理" class="sidebar-link">nginx反向代理</a></li><li class="sidebar-sub-header"><a href="/pages/browser/跨域通信.html#参考" class="sidebar-link">参考</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>浏览器安全可以分为三大块——<strong>web页面安全</strong>、<strong>浏览器网络安全</strong>和<strong>浏览器系统安全</strong>。同源策略是为实现web页面安全的一个策略，而跨域通信则是在某些必要场景下，想要不受同源策略限制的使用场景。</p> <p>首先我们来看看，如果没有web页面安全相关策略的话，我们的web世界会是怎样？</p> <ul><li>任何网页可加载和执行其他网页的脚本文件、视频、音频等</li> <li>可以修改银行、公安局等网页的DOM结构、CSSOM样式信息</li> <li>在银行站点内插入可执行脚本</li> <li>读取银行的站点的Cookie等数据</li></ul> <p>在不安全的web世界，我们是没有隐私的，因此我们需要web页面安全策略，而<strong>同源策略则是web页面最基本、最核心的安全策略</strong>。</p> <h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p>我们首先来看看什么是同源。</p> <h3 id="什么是同源？"><a href="#什么是同源？" class="header-anchor">#</a> 什么是同源？</h3> <p><strong>协议、域名、端口都相同</strong>的url地址，我们称之为同源。也就是说只要这三者中的任意一个不相同都不能称为同源。</p> <div class="language- extra-class"><pre class="language-text"><code>// 同源：协议、域名、端口相同，路径不同
https://juejin.com/a
https://juejin.com/b

// 同源：协议、域名、端口相同，参数不同
https://juejin.com/?category=1
https://juejin.com/?category=0

// 不同源：协议不同
https://juejin.com
http://juejin.com

// 不同源：域名不同
https://a.geekbang.org
http://b.geekbang.org

// 不同源：端口不同
https://juejin.com:3000
http://juejin.com:4000
</code></pre></div><h3 id="同源策略-2"><a href="#同源策略-2" class="header-anchor">#</a> 同源策略</h3> <p>同源策略是<strong>浏览器</strong>针对不同源之间的一套安全策略，用于限制不同源之间的一些非安全操作。</p> <h4 id="dom层面"><a href="#dom层面" class="header-anchor">#</a> DOM层面</h4> <p>首先，我们来看看同源之间如何操作DOM</p> <p>我们打开掘金首页（a页面），然后随便点一篇文章（b页面）进入，此时a页面与b页面同源。在b页面的控制台执行如下代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> pdom <span class="token operator">=</span> opener<span class="token punctuation">.</span>document<span class="token punctuation">;</span> <span class="token comment">// opener指向上个页面的Window对象</span>
pdom<span class="token punctuation">.</span>body<span class="token punctuation">.</span>style<span class="token punctuation">.</span>display <span class="token operator">=</span> <span class="token string">&quot;none&quot;</span>
</code></pre></div><p>通过opener获取a页面的Window对象，并将整个页面设为不可见，此时回到a页面，会发现是一片空白了。</p> <p>我再在掘金里随便找了个不同源的入口“商务合作”（c页面）进入，然后在c页面的控制台再执行以上代码，就会报错
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd2pxsxwqnj318804kt9n.jpg" alt="">
这就是<strong>同源策略限制不能获取非同源页面的DOM节点</strong>。</p> <h4 id="数据层面：cookie、indexdb、localstorage等"><a href="#数据层面：cookie、indexdb、localstorage等" class="header-anchor">#</a> 数据层面：Cookie、IndexDB、LocalStorage等</h4> <p><strong>同源策略限制不同源之间不能相互读取Cookie、IndexDB、LocalStorage等数据</strong>。
展开刚刚在b页面控制台打印的opener(a页面的Window)，可以看到里面还有很多数据（包括Cookie、IndexDB、LocalStorage）
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd2q3oib77j30vi0oygsi.jpg" alt=""></p> <p>但是展开c页面控制台打印的opener(a页面的Window)，会发现没有这些信息，也就不谈获取和操作了。</p> <h4 id="网络层面"><a href="#网络层面" class="header-anchor">#</a> 网络层面</h4> <p><strong>同源策略限制不同源之间不能进行Ajax通信</strong>。</p> <h2 id="跨域通信"><a href="#跨域通信" class="header-anchor">#</a> 跨域通信</h2> <p>同源策略虽然可以实现web页面的安全性，但在某些场景下，同时也带来了不便。因此在某些特定场景下，我们需要请求不同源之间的资源，因此我们要想办法实现跨域通信。</p> <p>我们先来看看不采取任何措施时，跨域通信会遇到什么问题。以下模拟服务端和客户端，实现了一次跨域Ajax通信</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 服务端servers.js</span>
<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//要响应回去的数据</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'hello world'</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用回调函数 , 并响应</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行<code>node server.js</code>，启动服务。此时在浏览器执行客户端代码：通过ajax访问<code>http://localhost:3000/test</code>：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 客户端client.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span><span class="token string">'http://localhost:3000/test'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>这时浏览器控制台会报错
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd1hc0hbszj30my018q36.jpg" alt=""></p> <p>意思就是，来自于origin为null的ajax请求被CORS策略阻拦了，也就是不满足同源策略，被拒绝了。</p> <blockquote><p>本地file页面的跨域请求Origin头为null</p></blockquote> <p>下面我们就来看看在同源策略的限制下，如何顺利的实现跨域通信。</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <h4 id="jsonp原理"><a href="#jsonp原理" class="header-anchor">#</a> JSONP原理</h4> <p>浏览器对非同源的Ajax请求做了限制，比如图片（img标签）、样式资源（link标签）和脚本文件（script）及等没有做相应限制。</p> <blockquote><p>如果要一个页面的所有资源都来至于统一源，也就是所有资源都部署在服务器上，这无疑是不可能的。因此浏览器给开了一个小口子，允许引用任意外部文件。但便利与安全是相斥的，因此这也带来诸多问题，比如XSS安全问题，这个后续在其他文章里再研究讨论。</p></blockquote> <p>JSONP就是利用同源策源对script没有限制这一点，相当于<strong>绕开了同源策略的限制</strong>，实现跨域通信。</p> <h4 id="jsonp的实现"><a href="#jsonp的实现" class="header-anchor">#</a> JSONP的实现</h4> <p>实现的原理及步骤如下：</p> <ul><li>在客户端声明一个回调函数(比如show），函数的形参为从服务端返回的数据(比如data)，函数体为对返回数据的处理和操作</li> <li>创建一个script标签，src赋值为<code>src=服务端接口地址?callback=show</code>，也就是以参数的形式将回调函数名传给服务端</li> <li>服务端收到请求后，拿到回调函数名show，把需要返回的资源包裹在show里，像这样<code>show(data)</code></li> <li>最后服务器将数据返回给客户端，由于客户端之前已经注册了show函数，因此收到返回后就会执行show函数，对返回数据data做相应操作</li></ul> <p>这也就是JSONP（JSON with padding）名字的来源，即填充式JSON，或者说被padding包裹着的JSON。这里的JSON就是服务端返回的json数据data，padding就是用来包裹data的回调函数。</p> <p>那接下来我们来模拟下JSONP的场景。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- 客户端client.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token comment">// 封装 JSONP函数</span>
    <span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> url<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callback <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            params <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> arrs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                arrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            arrs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">callback=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callback<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>arrs<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
            <span class="token comment">// 添加script标签</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 注册回调函数</span>
            window<span class="token punctuation">[</span>callback<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 前端调用</span>
    <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        url<span class="token operator">:</span> <span class="token string">'http://localhost:3000/test'</span><span class="token punctuation">,</span>
        params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        callback<span class="token operator">:</span> <span class="token string">'showData'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>服务端只需要获取callback的名称，然后要返回的数据包裹在callback里返回即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//要响应回去的数据</span>
  <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'hello world'</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 获取回调函数的名称</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>callback<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token comment">// 用callback包裹data，并返回</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>callback<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>浏览器控制台会打印出data</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'hello world'</span> <span class="token punctuation">}</span>
</code></pre></div><p>我们看下请求</p> <p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd1ja455moj30jy05wq3d.jpg" alt=""></p> <p>服务器返回<code>showData({&quot;title&quot;:&quot;hello world&quot;})</code>，由于window上我们已经注册了showData函数（callback函数），因此此时会执行showData函数，于是data被resolve，最终在then的成功回调函数中打印出data。</p> <h4 id="优缺点"><a href="#优缺点" class="header-anchor">#</a> 优缺点</h4> <p>优点：兼容性好。没有什么特殊的技术，就是普通的script标签请求。
缺点：只支持get请求，有一定安全问题。因为JSONP是利用script标签，因此就只能用get请求，并且存在script标签可能存在的一切安全问题，比如XSS。</p> <h4 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h4> <p>根据以上讨论，我们可以知道JSONP</p> <ul><li>原理：JSONP是利用同源策略对script标签未加限制这一点，<strong>绕过同源策略</strong></li> <li>实践：需要服务端配合</li> <li>优缺点：兼容性好，只支持get请求，存在安全问题。</li></ul> <h2 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h2> <p>JSONP是前端通过script标签绕过同源限制，而CORS则是与服务端约定好，直接让服务端将特定的域名设置为可访问的白名单，前端访问服务端时和同源Ajax完全一样，不需要做任何改动。</p> <h3 id="两种请求"><a href="#两种请求" class="header-anchor">#</a> 两种请求</h3> <p>浏览器将CORS请求分为两类：简单请求和非简单请求。
只要同时满足以下条件，就被判定为简单请求。</p> <div class="language- extra-class"><pre class="language-text"><code>1、请求方法为以下一种
GET
POST
PUT
2、头部不超过以下几个字段
Accept
Accept-Language
Content-Language
Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain
</code></pre></div><p>如果不同时满足以上条件，则被判为非简单请求，浏览器对这两类请求的处理方式是不一样。
实际上根据<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS#Preflighted_requests" target="_blank" rel="noopener noreferrer">MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这个判定条件更严格，大家可以看看，以上只是列出绝大部分场景下的判定条件。</p> <h3 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h3> <p>对于简单请求，浏览器会在CORS请求的头信息之中，增加一个Origin字段。Origin由协议、域名和端口组成，说明此次请求是来自于哪个源。</p> <p>服务器根据Origin字段判断</p> <ul><li>如果是不被允许的源，则服务器会返回一个正常的HTTP响应，浏览器收到这个响应时，发现没有<code>Access-Control-Allow-Origin</code>字段，就知道请求被拒绝了，就会抛出一个错误，被Ajax的onerror捕获。（注意，这个错误不是服务端返回的，是浏览器抛出的）</li> <li>如果是被允许的源，服务器会在响应的头部增加以下信息</li></ul> <div class="language- extra-class"><pre class="language-text"><code>Access-Control-Allow-Origin: http://juejin.com
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: FooBar
Content-Type: text/html; charset=utf-8
</code></pre></div><h4 id="access-control-allow-origin"><a href="#access-control-allow-origin" class="header-anchor">#</a> Access-Control-Allow-Origin</h4> <p>该字段是必须的，表示被允许的源。该字段只能被设为3个值：*、null和请求时的origin的值</p> <ul><li>”*“表示任何源都被允许</li> <li>&quot;null&quot;表示origin为null被允许。当直接通过本地file页面进行跨域请求时，origin为空。</li> <li>请求时的origin，代表origin在白名单里，服务端直接返回此origin值，代表此origin被允许</li></ul> <h4 id="access-control-allow-credentials"><a href="#access-control-allow-credentials" class="header-anchor">#</a> Access-Control-Allow-Credentials</h4> <p>该字段可选，表示是否允许携带Cookie。该字段只有一个值：true，若不允许则直接不传该字段。</p> <p>此响应头若要生效，需要客户端配合。开发者必须在Ajax请求中将withCredentials属性设为true，浏览器才会发送Cookie，否则即使服务端同意Cookie发送，浏览器也不会带上Cookie。</p> <p>同时要注意，CORS是对Ajax通信有效，Cookie依然会遵守同源策略的限制，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><p>当<code>Access-Control-Allow-Credentials</code>为true时，表示客户端可以再请求时带上Cookie。</p> <h4 id="access-control-expose-headers"><a href="#access-control-expose-headers" class="header-anchor">#</a> Access-Control-Expose-Headers</h4> <p>该字段可选。<code>XMLHttpRequest</code>的<code>getResponseHeader()</code>方法只能拿到如下6个基本字段：</p> <div class="language- extra-class"><pre class="language-text"><code>Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma
</code></pre></div><p>如果想要获取其他header字段，则必须要Access-Control-Expose-Headers指定的才可以拿到。</p> <h3 id="非简单请求"><a href="#非简单请求" class="header-anchor">#</a> 非简单请求</h3> <p>非简单请求的CORS请求，浏览器会在正式通信前，先发送一个预检请求，预检请求通过后，才会继续发送正常的请求。</p> <h4 id="_1、预检请求"><a href="#_1、预检请求" class="header-anchor">#</a> 1、预检请求</h4> <p>预检请求，就是在发送正式请求前，先去问下服务器，当前网页的源是否在服务器的白名单里，以及有哪些可使用的方法和表头等信息。只有服务器通过预检请求，浏览器才会发起正常请求。</p> <p>预检请求采用<code>OPTIONS</code>方法。<code>OPTIONS</code>请求会带上如下首部：</p> <ul><li><p>origin字段，该字段必须。由于是用于询问当前网页的源是否被允许，因此一定会带上origin字段。</p></li> <li><p>Access-Control-Request-Method字段，该字段必须。用于说明当前请求会用到的方法。</p></li> <li><p>Access-Control-Request-Headers字段，该字段可选。该字段值时一个用逗号分隔的字符串，用于说明CORS请求会额外发送的header。</p></li></ul> <p>服务器收到预检请求后，检查以上3个字段。</p> <p><strong>如果服务器拒绝了此次预检请求</strong>，则会返回一个正常的HTTP响应。浏览器收到响应后，发现没有包含任何CORS相关头信息，则判定服务器拒绝了此次请求，会抛出一个错误，被XMLHttpRequest对象的onerror回调函数捕获。同时，浏览器便不会继续后续的正常请求了。</p> <p><strong>如果服务器允许了此次预检请求</strong>，则会在HTTP响应中加入CORS相关的头信息字段。</p> <ul><li><p><code>Access-Control-Allow-Origin</code>字段，该字段必须。该字段被设置为请求头里的origin，表示允许此origin的访问（当然也可以设置为*，表示所有源都被允许）。</p></li> <li><p><code>Access-Control-Allow-Methods</code>字段，该字段必须。该字段为一个以逗号分隔的字符串，包含服务端可支持的所有方法。注意，不是仅包含当前访问的方法。</p></li> <li><p><code>Access-Control-Allow-Headers</code>字段，该字段与请求中的<code>Access-Control-Request-Headers</code>字段对应。如果请求包含了<code>Access-Control-Request-Headers</code>字段，则该字段必须。该字段也是一个以逗号分隔的字符串，包含了服务器支持的所有头信息字段，不限于浏览器在&quot;预检&quot;中请求的字段。</p></li> <li><p><code>Access-Control-Allow-Credentials</code>字段，该字段同简单请求</p></li> <li><p><code>Access-Control-Max-Age</code>字段，该字段可选。用于指定本次预检请求的有效期单位为秒。也就是说该预检请求的响应会被缓存，在此该值指定的时间内，再访问同一个服务端域名时，直接通过此缓存判断请求是否被允许即可，不需要再发送另一次预检请求。</p></li></ul> <h4 id="_2、正常请求"><a href="#_2、正常请求" class="header-anchor">#</a> 2、正常请求</h4> <p>通过预检请求后，浏览器会进行正常的请求，就和一个简单请求一样。</p> <h3 id="cors实践"><a href="#cors实践" class="header-anchor">#</a> CORS实践</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 服务端server.js</span>
<span class="token keyword">let</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> whitList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'null'</span><span class="token punctuation">]</span> <span class="token comment">//设置白名单</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> origin <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>origin
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>whitList<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 设置哪个源可以访问我</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> origin<span class="token punctuation">)</span>
		<span class="token comment">// 允许携带哪个头访问我</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
		<span class="token comment">// 允许哪个方法访问我</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span><span class="token punctuation">,</span> <span class="token string">'PUT'</span><span class="token punctuation">)</span>
		<span class="token comment">// 允许携带cookie</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token comment">// 预检的存活时间</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Max-Age'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
		<span class="token comment">// 允许返回的头</span>
		res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Expose-Headers'</span><span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span>
		
		<span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// OPTIONS请求不做任何处理</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'PUT'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
				title<span class="token operator">:</span> <span class="token string">'hello world'</span>
			<span class="token punctuation">}</span>
			res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'yh'</span><span class="token punctuation">)</span> <span class="token comment">//返回一个响应头，后台需设置</span>
			res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>		
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
				title<span class="token operator">:</span> <span class="token string">'hello world'</span>
			<span class="token punctuation">}</span>
			res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'yh'</span><span class="token punctuation">)</span> <span class="token comment">//返回一个响应头，后台需设置</span>
			res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>		
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><p>服务端将<code>Access-Control-Allow-Origin</code>设置为了null，是为了方便本地测试，真实场景这样设置会有风险，详情可参考<a href="https://www.jianjunchen.com/post/cors%E5%AE%89%E5%85%A8%E9%83%A8%E7%BD%B2%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" target="_blank" rel="noopener noreferrer">CORS配置安全漏洞<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- client.html --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">'name=yh'</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//前端设置是否带 cookie</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'PUT'</span><span class="token punctuation">,</span><span class="token string">'http://localhost:3000/getData'</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'yh'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function-variable function">onreadystatechange</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">200</span> <span class="token operator">||</span> xhr<span class="token punctuation">.</span>status <span class="token operator">==</span> <span class="token number">304</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
xhr.send(null)
</code></pre></div><p>在浏览器的network，我们可以看到在PUT方法前，先发送了一个OPTIONS请求。
<img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd1n3pmftwj30ol094abq.jpg" alt=""></p> <blockquote><p>若在浏览器看不到OPTIONS请求，则通过以下步骤可以看到OPTIONS方法：<br>
1、新标签页输入<code>chrome://flags/#out-of-blink-cors</code><br>
2、将Out of blink CORS设置为disabled<br>
3、重启chrome</p></blockquote> <h2 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage</h2> <p>postMessage能主要是实现多窗口间的跨域通信。只要一个origin窗口可以获得对另一个target窗口的引用targetWindow，然后通过<code>targetWindow.postMessage</code>向targetWindow发送消息，同时可监听targetWindow发来的消息</p> <div class="language-js extra-class"><pre class="language-js"><code>targetWindow<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> targetOrigin<span class="token punctuation">)</span>
originWindow<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// targetWindow发来的消息</span>
<span class="token punctuation">}</span>
</code></pre></div><p>targetWindow在接收到消息后，可恢复originWindow消息</p> <div class="language-js extra-class"><pre class="language-js"><code>targetWindow<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token comment">// originWindow发来的消息</span>
    e<span class="token punctuation">.</span>source<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> e<span class="token punctuation">.</span>origin<span class="token punctuation">)</span> <span class="token comment">// 通过e.source获取发送方的window对象originWindow</span>
 <span class="token punctuation">}</span>
</code></pre></div><p>根据以上，说明下需要注意的几个点</p> <ul><li><p>发送方必须要先可以获取到接收方window的引用（比如内嵌iframe的contentWindow属性、执行window.open返回的窗口对象、或者是命名过或数值索引的window.frames）</p></li> <li><p><code>window.postMessage</code>里的window是<strong>接收方的window</strong></p></li> <li><p>接收方无法主动给发送方发消息，必须在接收到发送方的消息后，才能通过<code>e.source</code>给发送方发送消息，因此此时才能拿到发送方的window，也就是<code>e.source</code></p></li></ul> <blockquote><p>更多详细的postMessage相关规范和使用后续再另起文章整理。可参考文章<a href="https://github.com/Monine/monine.github.io/issues/2" target="_blank" rel="noopener noreferrer">HTML5 跨域通信 API - window.postMessage()<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>和<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" target="_blank" rel="noopener noreferrer">MDN<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="websocket"><a href="#websocket" class="header-anchor">#</a> websocket</h2> <h2 id="node中间件代理"><a href="#node中间件代理" class="header-anchor">#</a> node中间件代理</h2> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <p>同源策略是浏览器的限制，如果<strong>两个不同源的服务器相互请求是不受同源策略限制</strong>的。因此，只需要在客户端和服务器中间，加一个与客户端同源的服务器（或者具有对其设置CORS权限的服务器），中转请求就可以实现客户端和服务器之间不同源的访问。</p> <p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gd3vmcftj3j30go06ljs0.jpg" alt=""></p> <p>在本地开发时，需要跨域访问服务器的接口，若采用webpack的devServer.proxy的方案，其原理就是node中间件代理</p> <div class="language- extra-class"><pre class="language-text"><code>proxy: {
    '/api': {
        target: 'http://your-api-server:port', //后端服务器地址
    }
}
</code></pre></div><p>设置target为目标服务器地址，当本地发起ajax请求时，请求是从localhost发出的，请求被代理服务器localhost接收，此时浏览器与代理服务器同域，因此可以顺利访问；然后代理服务器将请求转发给<code>http://your-api-server:port</code>，此时是两个服务器通信，不存在同源策略的限制，因此也可以顺利访问。</p> <h2 id="nginx反向代理"><a href="#nginx反向代理" class="header-anchor">#</a> nginx反向代理</h2> <p>原理与node中间件代理类似，都是通过中间代理服务器中转请求。假设A源要访问B源服务器
思路：通过nginx配置一个代理服务器，与A页面同源，反向代理到B源。这样A页面发请求时，直接向代理服务器（源为A）发起，请求会被转发给B，从而实现跨域。</p> <blockquote><p>更多详细后续再另其文章整理。</p></blockquote> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><a href="https://juejin.im/post/5e6c58b06fb9a07ce01a4199#heading-11" target="_blank" rel="noopener noreferrer">跨域总结:从CORS到Ngnix<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener noreferrer">跨域资源共享 CORS 详解<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/browser/cookie.html" class="prev">
        cookie
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e7fdb41b.js" defer></script><script src="/assets/js/2.b0083da8.js" defer></script><script src="/assets/js/62.94301d21.js" defer></script>
  </body>
</html>
